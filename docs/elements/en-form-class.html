<!DOCTYPE html>


<html>
<head>
  <title>en-form</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="../tpe.css" />
</head>
<body>
  <div class="container">
      <div class="header">
        <div class="topbar">
          <div id="logo" alt="TPE">
          </div>
          <h3>en-form</h3>
          <!-- <img id="logo" src="/images/TPE_logo_white.png" height="60px" alt="TPE" > -->
          <div class="links">
            <a href="https://github.com/mobily-enterprises/tpe" target="_blank" title="View on GitHub">
              <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
            </a>
          </div>
        </div>
        en-form
      </div>
      <div class="main">
        
          <div class="toc">
            <ul>
              
                
                
                  <li>
                      <a class="source " href="../index.html">
                          index
                      </a>
                  </li>
                
              
                
                
                  <li>
                      <a class="source " href="../quickstart-designers.html">
                          quickstart designers
                      </a>
                  </li>
                
              
                
                
                  <li>
                      <a class="source " href="../tutorials-designers.html">
                          tutorials designers
                      </a>
                  </li>
                
              
                
                
              
                
                
              
                
                
                  <li>
                      <a class="source " href="../quickstart-developers.html">
                          quickstart developers
                      </a>
                  </li>
                
              
                
                
                  <li>
                      <a class="source " href="../tutorials-developers.html">
                          tutorials developers
                      </a>
                  </li>
                
              
                
                
              
                
                
                  <li>
                      <a class="source  current " href="../elements.html">
                          elements
                      </a>
                  </li>
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
                  <li>
                      <a class="source " href="../mixins.html">
                          mixins
                      </a>
                  </li>
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
              
                
                
                  <li>
                      <a class="source " href="../appendices.html">
                          appendices
                      </a>
                  </li>
                
              
                
                
              
                
                
                  <li>
                      <a class="source " href="../material-theme.html">
                          material theme
                      </a>
                  </li>
                
              
            </ul>
          </div>
        
        <div class="contentPage">
          
            
            <p>This element implements HTML form functionality and also adds features
that help with common tasks in modern web aplications.</p>
<p>While it supports TPE components and native form elements, native elements
don’t get a reference to the en-form element in their ‘form’ property.</p>

            
              <div class='highlight'><pre><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LitElement</span>, html } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lit&#x27;</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StyleableMixin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../mixins/StyleableMixin.js&#x27;</span>
<span class="hljs-keyword">import</span> { formElement } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../lib/htmlApi.js&#x27;</span>
<span class="hljs-keyword">import</span> tpeRegistry <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../tpeRegistry&#x27;</span>

<span class="hljs-comment">/* globals customElements CustomEvent */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnForm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">StyleableMixin</span>(<span class="hljs-title class_">LitElement</span>) {
  get reflectProperties () {
    <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">super</span>.<span class="hljs-property">reflectProperties</span>, ...formElement]
  }

  get skipProperties () {
    <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">super</span>.<span class="hljs-property">skipProperties</span>, <span class="hljs-string">&#x27;elements&#x27;</span>, <span class="hljs-string">&#x27;checkValidity&#x27;</span>, <span class="hljs-string">&#x27;reportValidity&#x27;</span>, <span class="hljs-string">&#x27;reset&#x27;</span>, <span class="hljs-string">&#x27;submit&#x27;</span>]
  }

  <span class="hljs-keyword">static</span> get properties () {
    <span class="hljs-keyword">return</span> {

      <span class="hljs-attr">fetchingElement</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;fetching-element&#x27;</span>
      },

      <span class="hljs-attr">recordId</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;record-id&#x27;</span>
      },

      <span class="hljs-attr">setFormAfterSubmit</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;set-form-after-submit&#x27;</span>
      },

      <span class="hljs-attr">resetFormAfterSubmit</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;reset-form-after-submit&#x27;</span>
      },

      <span class="hljs-attr">validateOnLoad</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;validate-on-load&#x27;</span>
      },

      <span class="hljs-attr">validateOnRender</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;validate-on-render&#x27;</span>
      },

      <span class="hljs-attr">submitCheckboxesAsNative</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;submit-checkboxes-as-native&#x27;</span>

      },
      <span class="hljs-attr">noAutoload</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
        <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;no-autoload&#x27;</span>
      },</pre></div>
            
          
            
            <p>This will allow users to redefine methods declaratively</p>

            
              <div class='highlight'><pre>      <span class="hljs-attr">presubmit</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">attribute</span>: <span class="hljs-literal">false</span> },
      <span class="hljs-attr">response</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">attribute</span>: <span class="hljs-literal">false</span> },
      <span class="hljs-attr">incomingData</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">attribute</span>: <span class="hljs-literal">false</span> },
      <span class="hljs-attr">dataLoaded</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">attribute</span>: <span class="hljs-literal">false</span> },
      <span class="hljs-attr">extrapolateErrors</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">attribute</span>: <span class="hljs-literal">false</span> }

    }
  }

  <span class="hljs-title function_">constructor</span> () {
    <span class="hljs-variable language_">super</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validateOnLoad</span> = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validateOnRender</span> = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fetchingElement</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitCheckboxesAsNative</span> = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_boundRealtimeSubmitter</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_realTimeSubmitter</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">attemptedFlight</span> = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">attemptedFlightMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitObject</span> = {}</pre></div>
            
          
            
            <p>Set WAI-ARIA Role attribute as form</p>

            
              <div class='highlight'><pre>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;role&#x27;</span>, <span class="hljs-string">&#x27;form&#x27;</span>)
  }

  <span class="hljs-comment">/**
   * These methods were originally part of nn-form
   */</span>

  reportValidity () {</pre></div>
            
          
            
            <p>Check validity in form</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">let</span> valid = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> el.<span class="hljs-property">reportValidity</span> === <span class="hljs-string">&#x27;function&#x27;</span>) {</pre></div>
            
          
            
            <p>Native element may have customValidity set
by a server response. Clear any existing custom
errors and report validity</p>

            
              <div class='highlight'><pre>        el.<span class="hljs-title function_">setCustomValidity</span>(<span class="hljs-string">&#x27;&#x27;</span>)
        <span class="hljs-keyword">if</span> (!el.<span class="hljs-title function_">reportValidity</span>()) {
          valid = <span class="hljs-literal">false</span>
        }
      }
    }
    <span class="hljs-keyword">return</span> valid
  }

  clearAllCustomValidity (elements) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> elements) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> el.<span class="hljs-property">setCustomValidity</span> === <span class="hljs-string">&#x27;function&#x27;</span>) el.<span class="hljs-title function_">setCustomValidity</span>(<span class="hljs-string">&#x27;&#x27;</span>)
    }
  }

  checkValidity () {</pre></div>
            
          
            
            <p>Check validity in form</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">let</span> valid = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> el.<span class="hljs-property">checkValidity</span> === <span class="hljs-string">&#x27;function&#x27;</span>) {</pre></div>
            
          
            
            <p>Native element may have customValidity set
by a server response. Clear any existing custom
errors and report validity</p>

            
              <div class='highlight'><pre>        el.<span class="hljs-title function_">setCustomValidity</span>(<span class="hljs-string">&#x27;&#x27;</span>)
        <span class="hljs-keyword">if</span> (!el.<span class="hljs-title function_">checkValidity</span>()) {
          valid = <span class="hljs-literal">false</span>
        }
      }
    }
    <span class="hljs-keyword">return</span> valid
  }

  reset () {</pre></div>
            
          
            
            <p>TODO: Adjust this for radios in a nice sensible way</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) {
      <span class="hljs-keyword">const</span> valueSource = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getElementValueSource</span>(el)</pre></div>
            
          
            
            <p>Reset validity, so that error messages are also reset</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> el.<span class="hljs-property">setCustomValidity</span> === <span class="hljs-string">&#x27;function&#x27;</span>) el.<span class="hljs-title function_">setCustomValidity</span>(<span class="hljs-string">&#x27;&#x27;</span>)

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_radioElement</span>(el)) {
        el[valueSource] = el.<span class="hljs-title function_">getAttribute</span>(valueSource) !== <span class="hljs-literal">null</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkboxElement</span>(el)) {
        el[valueSource] = el.<span class="hljs-title function_">hasAttribute</span>(valueSource)
      } <span class="hljs-keyword">else</span> {
        el[valueSource] = el.<span class="hljs-title function_">getAttribute</span>(valueSource)
      }
    }
  }

  createSubmitObject (elements) {
    <span class="hljs-keyword">const</span> r = {}
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> elements) {
      <span class="hljs-keyword">const</span> elName = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;name&#x27;</span>)</pre></div>
            
          
            
            <p>Every submit element MUST have a name set</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> elName === <span class="hljs-string">&#x27;undefined&#x27;</span> || elName === <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span></pre></div>
            
          
            
            <p>Radio will only happen once thanks to checking for undefined</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> r[elName] !== <span class="hljs-string">&#x27;undefined&#x27;</span>) <span class="hljs-keyword">continue</span>
      <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">&#x27;no-submit&#x27;</span>)) <span class="hljs-keyword">continue</span></pre></div>
            
          
            
            <p>Checkboxes are special: they might be handled as native ones,
(NOTHING set if unchecked, and their value set if checked) or
as booleans (true for checked, or false for unchecked)</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkboxElement</span>(el)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">submitCheckboxesAsNative</span>) {</pre></div>
            
          
            
            <p>As native checkboxes.</p>

            
              <div class='highlight'><pre>          <span class="hljs-keyword">const</span> val = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFormElementValue</span>(elName)
          <span class="hljs-keyword">if</span> (val) r[elName] = val
        } <span class="hljs-keyword">else</span> {</pre></div>
            
          
            
            <p>As more app-friendly boolean value</p>

            
              <div class='highlight'><pre>          r[elName] = !!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFormElementValue</span>(elName)
        }</pre></div>
            
          
            
            <p>For “file” types (uploads), it will</p>

            
              <div class='highlight'><pre>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;type&#x27;</span>) === <span class="hljs-string">&#x27;file&#x27;</span> || el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;as-file&#x27;</span>) !== <span class="hljs-literal">null</span>) {
        r[elName] = el
      } <span class="hljs-keyword">else</span> {
        r[elName] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFormElementValue</span>(elName)
      }
    }
    <span class="hljs-keyword">return</span> r
  }

  getFormElementValue (elName) {
    <span class="hljs-keyword">const</span> elements = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>].<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;name&#x27;</span>) === elName)

    <span class="hljs-keyword">if</span> (!elements.<span class="hljs-property">length</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Trying to set&#x27;</span>, elName, <span class="hljs-string">&#x27;but no such element in form&#x27;</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> (elements.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">const</span> el = elements[<span class="hljs-number">0</span>]

      <span class="hljs-keyword">const</span> valueSource = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getElementValueSource</span>(el)
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkboxElement</span>(el)) {
        <span class="hljs-keyword">return</span> el[valueSource]
          ? (el.<span class="hljs-property">value</span> ? el.<span class="hljs-property">value</span> : <span class="hljs-string">&#x27;on&#x27;</span>)
          : <span class="hljs-literal">undefined</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_selectElement</span>(el)) {
        <span class="hljs-keyword">return</span> el[valueSource]
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> el[valueSource]
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> nonRadio = elements.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_radioElement</span>(el))
      <span class="hljs-keyword">if</span> (nonRadio.<span class="hljs-property">length</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Duplicate name&#x27;</span>, elName, <span class="hljs-string">&#x27;for non-radio elements&#x27;</span>)
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-keyword">const</span> checked = elements.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> valueSource = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getElementValueSource</span>(el)
        <span class="hljs-keyword">return</span> el[valueSource]
      })
      <span class="hljs-keyword">if</span> (checked) <span class="hljs-keyword">return</span> checked.<span class="hljs-property">value</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
    }
  }

  setFormElementValue (elName, value, skipHiddenElements) {
    <span class="hljs-keyword">const</span> el = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>].<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_radioElement</span>(el)) {
        <span class="hljs-keyword">return</span> el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;name&#x27;</span>) === elName &amp;&amp; el.<span class="hljs-property">value</span> === value
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;name&#x27;</span>) === elName
      }
    })</pre></div>
            
          
            
            <p>Don’t do anything if the element wasn’t found OR if the type was hidden
(which 99.9% of the time is set by the form)</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> ((!el || (el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;type&#x27;</span>) === <span class="hljs-string">&#x27;hidden&#x27;</span>)) &amp;&amp; skipHiddenElements) <span class="hljs-keyword">return</span></pre></div>
            
          
            
            <p>Get the original value</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">const</span> valueSource = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getElementValueSource</span>(el)</pre></div>
            
          
            
            <p>CHECKBOXES</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkboxElement</span>(el)) {
      el[valueSource] = !!value</pre></div>
            
          
            
            <p>RADIO
Radio elements</p>

            
              <div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_radioElement</span>(el)) {
      el[valueSource] = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">const</span> others = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>].<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span>
        el !== e &amp;&amp;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_radioElement</span>(el)
      )
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> other <span class="hljs-keyword">of</span> others) other[valueSource] = <span class="hljs-literal">false</span></pre></div>
            
          
            
            <p>SELECT
Selectable elements (with prop selectedIndex)</p>

            
              <div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_selectElement</span>(el)) {
      <span class="hljs-keyword">if</span> (!value) el.<span class="hljs-property">selectedIndex</span> = <span class="hljs-number">0</span>
      <span class="hljs-keyword">else</span> el[valueSource] = value</pre></div>
            
          
            
            <p>FILE INPUT</p>

            
              <div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;type&#x27;</span>) === <span class="hljs-string">&#x27;file&#x27;</span> || el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;as-file&#x27;</span>) !== <span class="hljs-literal">null</span>) {
      el.<span class="hljs-property">fileName</span> = value</pre></div>
            
          
            
            <p>Any other case</p>

            
              <div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      el[valueSource] = value
    }
  }

  _selectElement (el) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> el.<span class="hljs-property">selectedIndex</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span> || el.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">&#x27;as-select&#x27;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  _checkboxElement (el) {
    <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;type&#x27;</span>) === <span class="hljs-string">&#x27;checkbox&#x27;</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">&#x27;as-checkbox&#x27;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  _radioElement (el) {
    <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;type&#x27;</span>) === <span class="hljs-string">&#x27;radio&#x27;</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">&#x27;as-radio&#x27;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  _getElementValueSource (el) {
    <span class="hljs-keyword">if</span> (
      el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;type&#x27;</span>) === <span class="hljs-string">&#x27;checkbox&#x27;</span> ||
      el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;type&#x27;</span>) === <span class="hljs-string">&#x27;radio&#x27;</span> ||
      el.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">&#x27;as-checkbox&#x27;</span>) ||
      el.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">&#x27;as-radio&#x27;</span>)
    ) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;checked&#x27;</span>

    <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;value-source&#x27;</span>)) <span class="hljs-keyword">return</span> el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;value-source&#x27;</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;value&#x27;</span>
  }

  get elements () {</pre></div>
            
          
            
            <p>A tags (links) can have “name”, filter them out</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;[name]&#x27;</span>)].<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el.<span class="hljs-property">tagName</span> !== <span class="hljs-string">&#x27;A&#x27;</span>)
  }

  <span class="hljs-comment">/**
   * These methods were originally part of nn-form
   * (END)
   */</span>

  <span class="hljs-keyword">async</span> _allChildrenCompleted () {</pre></div>
            
          
            
            <p>Wait for all children to be ready to rock and roll</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) {</pre></div>
            
          
            
            <p>TODO: What about React, Vue, etc.? Uniform API across element libraries?</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> el.<span class="hljs-property">updateComplete</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span>) {
        <span class="hljs-keyword">await</span> el.<span class="hljs-property">updateComplete</span>
      }
    }
  }

  _realTimeSubmitter (e) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">submit</span>(e.<span class="hljs-property">target</span>)
  }

  connectedCallback () {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">connectedCallback</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_allChildrenCompleted</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) {
        <span class="hljs-keyword">const</span> realTime = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;real-time&#x27;</span>) !== <span class="hljs-literal">null</span>
        <span class="hljs-keyword">const</span> realTimeEvent = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;real-time-event&#x27;</span>) || <span class="hljs-string">&#x27;input&#x27;</span>
        <span class="hljs-keyword">if</span> (!realTime || !realTimeEvent) <span class="hljs-keyword">continue</span>
        el.<span class="hljs-title function_">addEventListener</span>(realTimeEvent, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_boundRealtimeSubmitter</span>)
      }
    })
  }

  disconnectedCallback () {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">disconnectedCallback</span>()
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) {
      <span class="hljs-keyword">const</span> realTime = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;real-time&#x27;</span>)
      <span class="hljs-keyword">if</span> (realTime === <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>
      <span class="hljs-keyword">const</span> realTimeEvent = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;real-time-event&#x27;</span>)
      <span class="hljs-keyword">if</span> (!realTimeEvent) <span class="hljs-keyword">continue</span>

      el.<span class="hljs-title function_">removeEventListener</span>(realTimeEvent, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_boundRealtimeSubmitter</span>)
    }
  }

  <span class="hljs-keyword">async</span> firstUpdated () {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">firstUpdated</span>()

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">validateOnRender</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_allChildrenCompleted</span>()</pre></div>
            
          
            
            <p>Check validity</p>

            
              <div class='highlight'><pre>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportValidity</span>()
    }
  }

  setFormElementValues (o) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> o) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFormElementValue</span>(k, o[k], <span class="hljs-literal">true</span>)
    }
  }

  setRecordObject (o) {
    o = { ...o }
    <span class="hljs-keyword">const</span> elHash = {}
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) elHash[el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;name&#x27;</span>)] = el

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(elHash)) {
      o[k] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFormElementValue</span>(k)
    }
    <span class="hljs-keyword">return</span> o
  }

  extrapolateErrors (o) {
    <span class="hljs-keyword">return</span> o
  }

  <span class="hljs-keyword">async</span> presubmit (fetchOptions) {}

  <span class="hljs-keyword">async</span> response (response, errs, fetchOptions) {} <span class="hljs-comment">// If (response !== null and response.ok), it worked</span>

  <span class="hljs-keyword">async</span> incomingData (o, op) {} <span class="hljs-comment">// op can be &#x27;autoload&#x27; or &#x27;submit&#x27;</span>

  <span class="hljs-keyword">async</span> dataLoaded (o, op) {} <span class="hljs-comment">// op can be &#x27;autoload&#x27; or &#x27;submit&#x27;</span></pre></div>
            
          
            
            <p>Disabled here is set (and checked) with both the attribute and the property
‘disabled’ since an element might be disabled in the html, but might
not have had a chance to render yet (in which case, for non-native elemtns,
it would mean that the property is not yet there, since the reflector hasn’t
yet run)</p>

            
              <div class='highlight'><pre>  _disableElements (elements) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">__disabled</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>()
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> elements) {
      <span class="hljs-keyword">if</span> (!el.<span class="hljs-property">disabled</span> &amp;&amp; !el.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">&#x27;disabled&#x27;</span>)) {
        el.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;disabled&#x27;</span>, <span class="hljs-literal">true</span>)
        el.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">__disabled</span>.<span class="hljs-title function_">set</span>(el, <span class="hljs-literal">true</span>)
      }
    }
  }

  _enableElements (elements) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">__disabled</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">__disabled</span> || <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>()
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> elements) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">__disabled</span>.<span class="hljs-title function_">has</span>(el)) {
        el.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">&#x27;disabled&#x27;</span>)
        el.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">__disabled</span>.<span class="hljs-title function_">delete</span>(el)
      }
    }
  }

  _fetchEl (specificElement) {</pre></div>
            
          
            
            <p>Tries to figure out what the fetching element is.
if fetching-element was passed, then it’s either considered an ID
or the element itself.
Otherwise it will look for an ee-network or with an element with class
.network. Finally, it will use <code>window</code></p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (specificElement) {
      <span class="hljs-keyword">let</span> pEl
      pEl = specificElement
      <span class="hljs-keyword">let</span> found = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">while</span> (pEl.<span class="hljs-property">parentElement</span>) {
        pEl = pEl.<span class="hljs-property">parentElement</span>
        <span class="hljs-keyword">if</span> (pEl.<span class="hljs-property">tagName</span> === <span class="hljs-string">&#x27;EE-NETWORK&#x27;</span> || pEl.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&#x27;network&#x27;</span>)) {
          found = <span class="hljs-literal">true</span>
          <span class="hljs-keyword">break</span>
        }
      }
      <span class="hljs-keyword">return</span> found ? pEl : <span class="hljs-variable language_">window</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">fetchingElement</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fetchingElement</span> === <span class="hljs-string">&#x27;string&#x27;</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">`#<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.fetchingElement}</span>`</span>)
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fetchingElement</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">let</span> maybeNetwork = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;ee-network&#x27;</span>)
        <span class="hljs-keyword">if</span> (!maybeNetwork) maybeNetwork = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.network&#x27;</span>)
        <span class="hljs-keyword">return</span> maybeNetwork || <span class="hljs-variable language_">window</span>
      }
    }
  }

  <span class="hljs-keyword">async</span> _wait (ms) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(resolve, ms)
    })
  }

  <span class="hljs-keyword">async</span> submit (specificElement) {</pre></div>
            
          
            
            <p>Clear all custom validities if they are set
Native elements will NEED this, or any invalid state
will persist even if validation passes
Then, make up submit object and check whether reportValidity returns
false (which basically means “abort”)</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (specificElement) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearAllCustomValidity</span>([specificElement])
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitObject</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSubmitObject</span>([specificElement])
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> specificElement.<span class="hljs-property">reportValidity</span> === <span class="hljs-string">&#x27;function&#x27;</span> &amp;&amp; !specificElement.<span class="hljs-title function_">reportValidity</span>()) <span class="hljs-keyword">return</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearAllCustomValidity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitObject</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSubmitObject</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportValidity</span>()) <span class="hljs-keyword">return</span>
    }</pre></div>
            
          
            
            <p>Give users the ability to listen to @submit and then Allow for a presubmit hook</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">const</span> submitEvent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">&#x27;submit&#x27;</span>, { <span class="hljs-attr">cancelable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">composed</span>: <span class="hljs-literal">true</span> })
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatchEvent</span>(submitEvent)
    <span class="hljs-keyword">if</span> (submitEvent.<span class="hljs-property">defaultPrevented</span>) <span class="hljs-keyword">return</span></pre></div>
            
          
            
            <p>inFlightMap is a map of all connections, using the specificElement
as key (or “window” if there is no specific element)</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">const</span> mapIndex = specificElement || <span class="hljs-variable language_">this</span></pre></div>
            
          
            
            <p>The connection is ongoing: add a “specificElement” to the attempted
field, and simply return.
Towards the end, this function will check that “attempted” which,
if set, means that the form needs to be resubmitted with that
specificElement</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">has</span>(mapIndex)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">set</span>(mapIndex, { <span class="hljs-attr">attempted</span>: <span class="hljs-literal">true</span> })
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">set</span>(mapIndex, { <span class="hljs-attr">attempted</span>: <span class="hljs-literal">false</span> })</pre></div>
            
          
            
            <p>The element’s method can only be null, POST or PUT.
If not null, and not “PUT”, it’s set to “POST”</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">let</span> elementMethod = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;method&#x27;</span>)
    <span class="hljs-keyword">if</span> (elementMethod &amp;&amp; elementMethod.<span class="hljs-title function_">toUpperCase</span>() !== <span class="hljs-string">&#x27;PUT&#x27;</span>) {
      elementMethod = <span class="hljs-string">&#x27;POST&#x27;</span>
    }</pre></div>
            
          
            
            <p>The ‘method’ attribute will have priority no matter what.
If <code>method</code> is not set, then it will depend on recordId (PUT if present,
POST if not)</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">const</span> method = elementMethod === <span class="hljs-literal">null</span>
      ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">recordId</span> ? <span class="hljs-string">&#x27;PUT&#x27;</span> : <span class="hljs-string">&#x27;POST&#x27;</span>
      : elementMethod</pre></div>
            
          
            
            <p>Set the url, which will also depend on recordId</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">const</span> action = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;action&#x27;</span>)
    <span class="hljs-keyword">if</span> (!action) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;The submitted form has no action URL set&#x27;</span>)
    <span class="hljs-keyword">const</span> url = action + (<span class="hljs-variable language_">this</span>.<span class="hljs-property">recordId</span> ? <span class="hljs-string">`/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.recordId}</span>`</span> : <span class="hljs-string">&#x27;&#x27;</span>)

    <span class="hljs-keyword">const</span> fetchOptions = {
      url,
      method,
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;enctype&#x27;</span>) || <span class="hljs-string">&#x27;application/json&#x27;</span> },
      <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;follow&#x27;</span>, <span class="hljs-comment">// manual, *follow, error</span>
      <span class="hljs-attr">body</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitObject</span> <span class="hljs-comment">// body data type must match &quot;Content-Type&quot; header</span>
    }</pre></div>
            
          
            
            <p>HOOK: Allow devs to customise the request about to be sent to the server</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">presubmit</span>(fetchOptions)</pre></div>
            
          
            
            <p>Disable the elements</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!specificElement) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_disableElements</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)</pre></div>
            
          
            
            <p>Delete the multipart/form-data header if it was set, since
the browser will set it (with the right boundary parameter)
<a href="https://muffinman.io/uploading-files-using-fetch-multipart-form-data/">https://muffinman.io/uploading-files-using-fetch-multipart-form-data/</a>
<a href="https://stackoverflow.com/questions/35192841/fetch-post-with-multipart-form-data">https://stackoverflow.com/questions/35192841/fetch-post-with-multipart-form-data</a></p>
<p>ALSO turn body into a FormData object, with all values appended.
Note that for files. createSubmitObject will assign the element itself
as the value.</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (fetchOptions.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Content-Type&#x27;</span>] === <span class="hljs-string">&#x27;multipart/form-data&#x27;</span>) {
      <span class="hljs-keyword">delete</span> fetchOptions.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Content-Type&#x27;</span>]

      <span class="hljs-keyword">const</span> body = fetchOptions.<span class="hljs-property">body</span>
      <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> body) {
        <span class="hljs-keyword">if</span> (body[k] <span class="hljs-keyword">instanceof</span> HTMLElement) {
          <span class="hljs-keyword">const</span> filesInEl = body[k].<span class="hljs-property">files</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> f <span class="hljs-keyword">of</span> filesInEl) formData.<span class="hljs-title function_">append</span>(k, f)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> body[k] === <span class="hljs-string">&#x27;undefined&#x27;</span> || body[k] === <span class="hljs-literal">null</span>) formData.<span class="hljs-title function_">append</span>(k, <span class="hljs-string">&#x27;&#x27;</span>)
          <span class="hljs-keyword">else</span> formData.<span class="hljs-title function_">append</span>(k, body[k])
        }
      }
      fetchOptions.<span class="hljs-property">body</span> = formData
    }</pre></div>
            
          
            
            <p>Attempt the submission</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">let</span> networkError = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">let</span> response
    <span class="hljs-keyword">let</span> errs
    <span class="hljs-keyword">const</span> body =
      fetchOptions.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Content-Type&#x27;</span>] === <span class="hljs-string">&#x27;application/json&#x27;</span> &amp;&amp;
      <span class="hljs-keyword">typeof</span> fetchOptions.<span class="hljs-property">body</span> === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp;
      fetchOptions.<span class="hljs-property">body</span> !== <span class="hljs-literal">null</span>
        ? <span class="hljs-variable constant_">JSON</span>.<span class="hljs-title function_">stringify</span>(fetchOptions.<span class="hljs-property">body</span>)
        : fetchOptions.<span class="hljs-property">body</span>
    <span class="hljs-keyword">try</span> {</pre></div>
            
          
            
            <p>fetch() wants a stingified body</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">const</span> fo = { ...fetchOptions, ...{ <span class="hljs-attr">body</span>: body } }
      <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_fetchEl</span>(specificElement)
      response = <span class="hljs-keyword">await</span> el.<span class="hljs-title function_">fetch</span>(fetchOptions.<span class="hljs-property">url</span>, fo)
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ERROR!&#x27;</span>, e)
      networkError = <span class="hljs-literal">true</span>
    }</pre></div>
            
          
            
            <p>CASE #1: network error.</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (networkError) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Network error!&#x27;</span>)</pre></div>
            
          
            
            <p>Re-enable the elements</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!specificElement) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_enableElements</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_wait</span>(<span class="hljs-number">0</span>)
      }</pre></div>
            
          
            
            <p>Emit event to make it possible to tell the user via UI about the problem</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">const</span> event = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">&#x27;form-error&#x27;</span>, { <span class="hljs-attr">detail</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;network&#x27;</span> }, <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">composed</span>: <span class="hljs-literal">true</span> })
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatchEvent</span>(event)</pre></div>
            
          
            
            <p>Response hook</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">response</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, fetchOptions)</pre></div>
            
          
            
            <p>CASE #2: HTTP error.
Invalidate the problem fields</p>

            
              <div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {</pre></div>
            
          
            
            <p>Try and get the errors object from the reponse’s json</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">let</span> originalErrs
      <span class="hljs-keyword">try</span> {
        originalErrs = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
      } <span class="hljs-keyword">catch</span> (e) {
        originalErrs = {}
      }
      errs = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extrapolateErrors</span>(originalErrs) || {}</pre></div>
            
          
            
            <p>Emit event to make it possible to tell the user via UI about the problem</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">const</span> event = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">&#x27;form-error&#x27;</span>, { <span class="hljs-attr">detail</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;http&#x27;</span>, response, errs }, <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">composed</span>: <span class="hljs-literal">true</span> })
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatchEvent</span>(event)</pre></div>
            
          
            
            <p>Re-enable the elements
This must happen before setCustomValidity() and reportValidity()</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!specificElement) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_enableElements</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_wait</span>(<span class="hljs-number">0</span>)
      }</pre></div>
            
          
            
            <p>Set error messages</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (errs.<span class="hljs-property">errors</span> &amp;&amp; errs.<span class="hljs-property">errors</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> elHash = {}
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>) {
          elHash[el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;name&#x27;</span>)] = el
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> err <span class="hljs-keyword">of</span> errs.<span class="hljs-property">errors</span>) {
          <span class="hljs-keyword">const</span> el = elHash[err.<span class="hljs-property">field</span>]
          <span class="hljs-keyword">if</span> (el &amp;&amp; el.<span class="hljs-property">setCustomValidity</span>) {
            el.<span class="hljs-title function_">setCustomValidity</span>(err.<span class="hljs-property">message</span>)
            el.<span class="hljs-title function_">reportValidity</span>()
          }
        }
      }</pre></div>
            
          
            
            <p>Response hook</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">response</span>(response, errs, fetchOptions)</pre></div>
            
          
            
            <p>CASE #3: NO error. Set fields to their
new values</p>

            
              <div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {</pre></div>
            
          
            
            <p>Convert the result to JSON</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">const</span> v = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()

      <span class="hljs-keyword">let</span> attempted
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">has</span>(mapIndex)) {
        attempted = <span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">get</span>(mapIndex).<span class="hljs-property">attempted</span>
      }

      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">incomingData</span>(v, <span class="hljs-string">&#x27;submit&#x27;</span>)</pre></div>
            
          
            
            <p>HOOK Set the form values, in case the server processed some values
Note: this is only ever called if set-form-after-submit was
passed to the form.</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">setFormAfterSubmit</span>) {</pre></div>
            
          
            
            <p>Won’t overwrite fields if another attempt is queued</p>

            
              <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!attempted) {
          <span class="hljs-keyword">if</span> (!specificElement) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFormElementValues</span>(v)
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">const</span> name = mapIndex.<span class="hljs-property">name</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFormElementValues</span>({ [name]: v[name] })
          }
        }
      }</pre></div>
            
          
            
            <p>Re-enable the elements</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!specificElement) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_enableElements</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_wait</span>(<span class="hljs-number">0</span>)
      }</pre></div>
            
          
            
            <p>Maybe reset the form if it was so required</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">resetFormAfterSubmit</span> &amp;&amp; !attempted &amp;&amp; !specificElement) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reset</span>()

      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dataLoaded</span>(v, <span class="hljs-string">&#x27;submit&#x27;</span>)</pre></div>
            
          
            
            <p>Emit event to make it possible to tell the user via UI about the problem</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">const</span> event = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">&#x27;form-ok&#x27;</span>, { <span class="hljs-attr">detail</span>: { response }, <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">composed</span>: <span class="hljs-literal">true</span> })
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatchEvent</span>(event)</pre></div>
            
          
            
            <p>Response hook</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">response</span>(response, v, fetchOptions)
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">has</span>(mapIndex)) {
      <span class="hljs-keyword">const</span> attempted = <span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">get</span>(mapIndex).<span class="hljs-property">attempted</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">inFlightMap</span>.<span class="hljs-title function_">delete</span>(mapIndex)
      <span class="hljs-keyword">if</span> (attempted) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">submit</span>(specificElement)
      }
    }
  }

  <span class="hljs-keyword">async</span> updated (changedProperties) {</pre></div>
            
          
            
            <p>The ‘await’ here has the side effect of waiting for the next tick,
which means that children elements will have a chance to render</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">updated</span>()</pre></div>
            
          
            
            <p>If no-autoload is set to true, or there is no autoload or no recordId,
simply give up: nothing to do</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">noAutoload</span> || !changedProperties.<span class="hljs-title function_">has</span>(<span class="hljs-string">&#x27;recordId&#x27;</span>)) <span class="hljs-keyword">return</span></pre></div>
            
          
            
            <p>Record ID must be “something”</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">recordId</span> === <span class="hljs-string">&#x27;undefined&#x27;</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">recordId</span> === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">preloadData</span>()
  }

  <span class="hljs-keyword">async</span> preloadData () {</pre></div>
            
          
            
            <p>Work out the action’s URL, adding the record ID  at the end
(It will be a get)
If there is a result, fetch the element values</p>

            
              <div class='highlight'><pre>    <span class="hljs-keyword">const</span> action = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;action&#x27;</span>)
    <span class="hljs-keyword">let</span> response
    <span class="hljs-keyword">if</span> (action) {</pre></div>
            
          
            
            <p>This will make sure that the element is actually visible
before doing the fetch</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateComplete</span></pre></div>
            
          
            
            <p>Disable elements</p>

            
              <div class='highlight'><pre>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_disableElements</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)</pre></div>
            
          
            
            <p>Fetch the data and trasform it to json</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">let</span> v
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_fetchEl</span>()
        response = <span class="hljs-keyword">await</span> el.<span class="hljs-title function_">fetch</span>(action + <span class="hljs-string">&#x27;/&#x27;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">recordId</span>)
        v = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;WARNING: Fetching element failed to fetch&#x27;</span>)
        v = {}
      }

      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">incomingData</span>(v, <span class="hljs-string">&#x27;autoload&#x27;</span>)</pre></div>
            
          
            
            <p>Set values</p>

            
              <div class='highlight'><pre>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFormElementValues</span>(v)</pre></div>
            
          
            
            <p>Re-enabled all disabled fields</p>

            
              <div class='highlight'><pre>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_enableElements</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>)
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_wait</span>(<span class="hljs-number">0</span>)</pre></div>
            
          
            
            <p>Run reportValidity if validateOnLoad is on</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">validateOnLoad</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportValidity</span>()
      }</pre></div>
            
          
            
            <p>Run hook</p>

            
              <div class='highlight'><pre>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dataLoaded</span>(v, <span class="hljs-string">&#x27;autoload&#x27;</span>)
    }
  }

  render () {
    
    <span class="hljs-keyword">return</span> html`<span class="language-xml">
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    `</span>
  }
}
tpeRegistry.<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;ee-form&#x27;</span>, <span class="hljs-title class_">EnForm</span>)</pre></div>
            
          
        </div>
      </div>
    </div>
    <div class="bottombar">

    </div>
  </div>
</body>
</html>
